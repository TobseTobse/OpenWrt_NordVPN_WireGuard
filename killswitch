#!/bin/ash

LAN_IF="br-lan"
WG_IF="wg0"

# Helper to extract WAN interface names from firewall config
get_wan_ifs() {
  . /lib/functions.sh

  WAN_IFS=""
  check_zone() {
    local name="$1" zname net
    config_get zname "$name" name
    [ "$zname" = "wan" ] || return 0
    for net in $(config_get "$name" network); do
      WAN_IFS="$WAN_IFS $net"
    done
  }

  config_load firewall
  config_foreach check_zone zone
  echo "$WAN_IFS"
}

WAN_IFS="$(get_wan_ifs)"

echo "[*] Creating killswitch..."

# Create table and chain if not already present
nft list table inet killswitch >/dev/null 2>&1 || \
nft add table inet killswitch

nft list chain inet killswitch forward >/dev/null 2>&1 || \
nft add chain inet killswitch forward \
"{ type filter hook forward priority 0; policy accept; }"

# Clean existing LAN->WAN rules in our chain (idempotent)
for IF in $WAN_IFS; do
  nft delete rule inet killswitch forward \
  handle $(nft -a list chain inet killswitch forward | \
  awk "/iifname \\\"$LAN_IF\\\" oifname \\\"$IF\\\"/ {print \$NF}") \
  2>/dev/null
done

# Add drop rules LAN->WAN
for IF in $WAN_IFS; do
  echo -e "\033[1;32m[+] Killswitch established: drop $LAN_IF -> $IF\033[0m"
  nft add rule inet killswitch forward \
  iifname "$LAN_IF" oifname "$IF" counter drop 2>/dev/null
done
